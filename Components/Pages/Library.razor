@page "/Library"
@using Zine.App.Enums
@using Zine.App.Model
@using Zine.App.Model.DB
@using Zine.App.Services
@using Zine.Window
@using Zine.Components.Components.Library

<div class="flex justify-between items-center mb-4">
	<ImportComicButton Import="@Import" />

	<MudTextField
		Value="@SearchWord"
		class="max-w-xs"
		Label="Search"
		Variant="Variant.Outlined"
		Clearable="true"
		AutoGrow="true"
		Adornment="Adornment.Start"
		AdornmentIcon="@Icons.Material.Filled.Search"
		DebounceInterval="500"
		TextChanged="SearchByTitle" />
</div>


<MudGrid class="mx-auto" Justify="Justify.Center">

	@* Display groups *@
	@foreach (var group in Groups)
	{
		<GroupCard Group="@group"/>
	}

	@* Display comicbooks *@
	@foreach (var comic in FilteredComics)
	{
		<ComicBookCard ComicBook="comic"/>
	}


</MudGrid>


@code
{
	[Inject]
	private ISnackbar? Snackbar { get; set; }

	[Inject]
	private IComicBookService? ComicBookService { get; set; }

	string SearchWord { get; set; } = "";
	List<ComicBook> OriginalComicsList { get; set; } = [];
	List<ComicBook> FilteredComics { get; set; } = [];
	List<string> Groups { get; set; } = ["Comics I want to read", "Comics I should read", "Comics I need to read"];

	protected void SearchByTitle(string searchTerm)
	{
		SearchWord = searchTerm;
		FilteredComics = OriginalComicsList.Where(comic => comic.Name.Contains(SearchWord)).ToList();
	}

	private void Import((ImportType importType, string path) args)
	{
		try
		{
			bool importSuccessful = ComicBookService!.ImportFromDisk(args.importType, args.path);

			if (!importSuccessful)
				Snackbar!.Add("An error occured during importing...", Severity.Error);
			else
			{
				Snackbar!.Add("Successfully imported comic books.", Severity.Success);
				LoadComics();
			}
		}
		catch (ArgumentOutOfRangeException e)
		{
			Snackbar!.Add(e.Message, Severity.Error);
		}
	}

	private void LoadComics()
	{
		SearchWord = "";
		FilteredComics = OriginalComicsList = ComicBookService!.GetAll().ToList();
	}

	protected override void OnInitialized()
	{
		base.OnInitialized();
		PageTitleManager.PageTitle = "Library";
		LoadComics();
	}
}
